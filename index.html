<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pickleball Stream Overlay</title>
    <script src="https://sdk.videosdk.live/js-sdk/0.1.6/videosdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            width: 1920px;
            height: 1080px;
            background: #000;
            font-family: Arial, sans-serif;
            position: relative;
        }
        
        #videoContainer {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        #videoContainer video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .overlay {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            padding: 30px 60px;
            border-radius: 20px;
            color: white;
            display: flex;
            gap: 50px;
            align-items: center;
            z-index: 100;
            border: 3px solid rgba(255,255,255,0.2);
        }
        
        .team-box {
            text-align: center;
            min-width: 120px;
        }
        
        .team {
            font-size: 24px;
            margin-bottom: 10px;
            text-transform: uppercase;
            opacity: 0.9;
        }
        
        .score {
            font-size: 72px;
            font-weight: bold;
        }
        
        .serving {
            color: #ffeb3b !important;
        }
        
        .vs {
            font-size: 36px;
            opacity: 0.6;
        }
        
        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #0f0;
            font-size: 12px;
            z-index: 200;
        }
    </style>
</head>
<body>
    <div id="status">Initializing...</div>
    <div id="videoContainer"></div>
    
    <div class="overlay">
        <div class="team-box">
            <div class="team" id="teamA">Team A</div>
            <div class="score" id="scoreA">0</div>
        </div>
        <div class="vs">VS</div>
        <div class="team-box">
            <div class="team" id="teamB">Team B</div>
            <div class="score" id="scoreB">0</div>
        </div>
    </div>

    <script>
        // KRITISCH: Query Parameter extrahieren
        const urlParams = new URLSearchParams(window.location.search);
        const meetingId = urlParams.get("meetingId");
        const token = urlParams.get("token");
        const participantId = urlParams.get("participantId");
        
        document.getElementById('status').innerHTML = `Meeting: ${meetingId ? meetingId : 'NO MEETING ID'}`;
        
        if (!meetingId || !token || !participantId) {
            console.error("Missing required parameters!");
            document.getElementById('status').innerHTML = "ERROR: Missing parameters!";
        } else {
            // VideoSDK initialisieren
            window.VideoSDK.config(token);
            
            const meeting = window.VideoSDK.initMeeting({
                meetingId: meetingId,
                name: "recorder",
                micEnabled: false,
                webcamEnabled: false,
                participantId: participantId,
                mode: "VIEWER"
            });
            
            // Meeting Events
            meeting.on("meeting-joined", () => {
                console.log("Template joined meeting!");
                document.getElementById('status').innerHTML = "Meeting joined!";
            });
            
            meeting.on("participant-joined", (participant) => {
                console.log("Participant joined:", participant.displayName);
                
                // Nur für CONFERENCE Teilnehmer (nicht für VIEWER)
                if (participant.mode === "CONFERENCE") {
                    let videoElement = document.createElement("video");
                    videoElement.setAttribute("id", `v-${participant.id}`);
                    videoElement.setAttribute("autoplay", true);
                    videoElement.setAttribute("playsinline", true);
                    videoElement.muted = true;
                    
                    participant.on("stream-enabled", (stream) => {
                        if (stream.kind === "video") {
                            const mediaStream = new MediaStream();
                            mediaStream.addTrack(stream.track);
                            videoElement.srcObject = mediaStream;
                            videoElement.play();
                        }
                    });
                    
                    // Existierende Videos entfernen
                    document.getElementById("videoContainer").innerHTML = "";
                    document.getElementById("videoContainer").appendChild(videoElement);
                    
                    // Check if stream already exists
                    const videoStream = participant.streams.get("video");
                    if (videoStream && videoStream.track) {
                        const mediaStream = new MediaStream();
                        mediaStream.addTrack(videoStream.track);
                        videoElement.srcObject = mediaStream;
                        videoElement.play();
                    }
                }
            });
            
            // PubSub für Score Updates
            meeting.on("meeting-joined", () => {
                meeting.pubSub.subscribe("SCORE_UPDATE", (data) => {
                    console.log("Score update received:", data);
                    if (data && data.message) {
                        const msg = data.message;
                        document.getElementById('scoreA').textContent = msg.scoreA || 0;
                        document.getElementById('scoreB').textContent = msg.scoreB || 0;
                        document.getElementById('teamA').textContent = msg.teamA || 'Team A';
                        document.getElementById('teamB').textContent = msg.teamB || 'Team B';
                        
                        document.getElementById('teamA').classList.toggle('serving', msg.server === 'A');
                        document.getElementById('teamB').classList.toggle('serving', msg.server === 'B');
                    }
                });
            });
            
            // AUTOMATISCH BEITRETEN - KRITISCH!
            meeting.join();
        }
    </script>
</body>
</html>
