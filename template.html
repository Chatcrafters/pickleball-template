<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pickleball Stream Template</title>
    <script src="https://sdk.videosdk.live/js-sdk/0.1.6/videosdk.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { width: 1920px; height: 1080px; background: #000; position: relative; overflow: hidden; font-family: Arial, sans-serif; }
        #video-container { width: 100%; height: 100%; position: relative; }
        .participant-video { width: 100%; height: 100%; object-fit: cover; }
        .score-overlay {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            padding: 25px 60px;
            border-radius: 20px;
            display: flex;
            gap: 50px;
            align-items: center;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255,255,255,0.1);
        }
        .team-score { text-align: center; min-width: 150px; }
        .team-name { font-size: 24px; margin-bottom: 10px; color: #ffffff; font-weight: 600; text-transform: uppercase; }
        .score { font-size: 72px; font-weight: bold; color: #ffffff; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .serving { color: #ffeb3b !important; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .vs { font-size: 36px; color: rgba(255,255,255,0.5); font-weight: bold; }
        .debug { position: absolute; top: 10px; left: 10px; color: #0f0; font-family: monospace; font-size: 12px; background: rgba(0,0,0,0.8); padding: 5px; }
    </style>
</head>
<body>
    <div id="debug"></div>
    <div id="video-container"></div>
    <div class="score-overlay">
        <div class="team-score">
            <div class="team-name" id="teamAName">Team A</div>
            <div class="score" id="scoreA">0</div>
        </div>
        <div class="vs">VS</div>
        <div class="team-score">
            <div class="team-name" id="teamBName">Team B</div>
            <div class="score" id="scoreB">0</div>
        </div>
    </div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const meetingId = urlParams.get('meetingId');
        const token = urlParams.get('token');
        
        let meeting = null;
        let gameState = { scoreA: 0, scoreB: 0, teamAName: 'Team A', teamBName: 'Team B', server: 'A' };
        
        function debug(msg) {
            console.log(msg);
            document.getElementById('debug').innerHTML += msg + '<br>';
        }
        
        async function init() {
            debug('Template starting: ' + meetingId);
            
            if (!meetingId || !token) {
                debug('Missing parameters!');
                return;
            }
            
            try {
                window.VideoSDK.config(token);
                
                meeting = window.VideoSDK.initMeeting({
                    meetingId: meetingId,
                    participantId: 'TEMPLATE_' + Date.now(),
                    name: "Stream Template",
                    micEnabled: false,
                    webcamEnabled: false,
                    mode: "VIEWER"
                });
                
                meeting.on("meeting-joined", () => {
                    debug("Template joined!");
                    setupParticipants();
                    setupPubSub();
                });
                
                meeting.on("participant-joined", (participant) => {
                    if (participant.mode === "CONFERENCE") {
                        setupParticipantVideo(participant);
                    }
                });
                
                await meeting.join();
            } catch (error) {
                debug('Error: ' + error.message);
            }
        }
        
        function setupParticipants() {
            const participants = [...meeting.participants.values()];
            participants.forEach(participant => {
                if (participant.mode === "CONFERENCE") {
                    setupParticipantVideo(participant);
                }
            });
        }
        
        function setupParticipantVideo(participant) {
            debug('Video for: ' + participant.displayName);
            const videoContainer = document.getElementById('video-container');
            const videoElement = document.createElement('video');
            videoElement.className = 'participant-video';
            videoElement.autoplay = true;
            videoElement.playsInline = true;
            videoElement.muted = true;
            
            participant.on("stream-enabled", (stream) => {
                if (stream.kind === 'video') {
                    const mediaStream = new MediaStream([stream.track]);
                    videoElement.srcObject = mediaStream;
                    videoElement.play();
                }
            });
            
            videoContainer.innerHTML = '';
            videoContainer.appendChild(videoElement);
            
            const videoStream = participant.streams.get('video');
            if (videoStream && videoStream.track) {
                const mediaStream = new MediaStream([videoStream.track]);
                videoElement.srcObject = mediaStream;
                videoElement.play();
            }
        }
        
        function setupPubSub() {
            meeting.pubSub.subscribe("SCORE_UPDATE", (data) => {
                debug("Score update!");
                if (data && data.message) {
                    updateScore(data.message);
                }
            });
        }
        
        function updateScore(data) {
            gameState = { ...gameState, ...data };
            document.getElementById('scoreA').textContent = gameState.scoreA;
            document.getElementById('scoreB').textContent = gameState.scoreB;
            document.getElementById('teamAName').textContent = gameState.teamAName;
            document.getElementById('teamBName').textContent = gameState.teamBName;
            document.getElementById('teamAName').classList.toggle('serving', gameState.server === 'A');
            document.getElementById('teamBName').classList.toggle('serving', gameState.server === 'B');
        }
        
        window.addEventListener('load', init);
    </script>
</body>
</html>
